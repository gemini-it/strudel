---
title: Sons
layout: ../../layouts/MainLayout.astro
---

import { MiniRepl } from '../../docs/MiniRepl';

# Sons

Regardons de plus près comment les sons sont implémentés dans la sortie webaudio.

## Enregistrer un son

Tous les sons sont enregistrés dans la carte des sons, en utilisant la fonction `registerSound` :

```ts
function registerSound(
  name: string, // Le nom du son qui devrait être donné à `s`, par exemple `mysaw`
  // La fonction appelée par le planificateur pour déclencher le son :
  (
    time: number, // Le temps du contexte audio où le son devrait commencer
    value: object, // La valeur du `Hap`
    onended: () => void // Un callback qui devrait être déclenché quand le son est terminé
  ) => {
    node: AudioNode, // noeud à connecter au reste de la chaîne d'effets
    stop: (time:number) => void // une fonction qui arrêtera le son
  },
  data: object // méta données, uniquement pour la logique UI dans l'onglet sons
);
```

Lorsque `registerSound` est appelé, il enregistre `{ onTrigger, data }` sous le `name` donné dans une [carte nanostore](https://github.com/nanostores/nanostores#maps).

### Exemple

Cela peut être un peu abstrait, voici donc un exemple minimal :

```js
registerSound(
  'mysaw',
  (time, value, onended) => {
    let { freq } = value; // déstructurer les paramètres de contrôle
    const ctx = getAudioContext();
    // créer un oscillateur
    const o = new OscillatorNode(ctx, { type: 'sawtooth', frequency: Number(freq) });
    o.start(time);
    // ajouter un noeud de gain pour baisser le niveau de l'osc
    const g = new GainNode(ctx, { gain: 0.3 });
    // connecter osc au gain
    const node = o.connect(g);
    // cette fonction peut être appelée de l'extérieur pour arrêter le son
    const stop = (time) => o.stop(time);
    // ended sera déclenché quand stop aura été appelé
    o.addEventListener('ended', () => {
      o.disconnect();
      g.disconnect();
      onended();
    });
    return { node, stop };
  },
  { type: 'synth' },
);
// utiliser le son
freq(220, 440, 330).s('mysaw');
```

Vous pouvez réellement utiliser ce code dans le [REPL](https://strudel.cc/) et ça fonctionnera.
Après avoir évalué le code, vous devriez voir `mysaw` listé dans l'onglet sons.

## Jouer des sons

Voici maintenant ce qui se passe lorsqu'un son est joué :
Lorsque la sortie webaudio joue un `Hap`, elle recherchera et appellera la fonction `onTrigger` pour le `s` donné.
Le `node` retourné peut alors être connecté au reste de la chaîne d'effets standard.
Avoir la fonction stop séparée permet également de jouer des sons via midi, où vous ne savez pas combien de temps le noteon durera.
